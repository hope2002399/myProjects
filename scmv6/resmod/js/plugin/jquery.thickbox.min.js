(function($) {
	$.fn.extend({
		thickbox: function(options) {
			var defaults = {
					ctxpath:"",
					resmod:"/resmod",
					title:null,
					type:"",
					parameters:{},
					rank_menu:false,
					rank_menu_position:84,
					loadimg:"/images/loading.gif",
					isShowImgLink:true,
					urlTypes:{},
					closeEvent:null,
					closeStr: typeof locale != "undefined" && 'zh_CN' == locale ? '关闭':'Close'
			};
			options = $.extend({},defaults, {
				target : this
			}, options);
			return this.each(function() {
				new $.Thickbox(this, options);
			});
		}
	});
	$.Thickbox = function(obj, options) {
		//判断是否已经绑定了click:tb_init_click事件，如果未绑定，则重新绑定
		if($(obj).attr("thickbox_bound") == 1){
			return;
		}
		$(obj).attr("thickbox_bound","1");
		
		$(obj).bind("click",tb_init_click);
		//如果该控件是创建群组模块中的群组介绍图片上传功能，则绑定点击事件后，立即触发
		if($(obj).is(".cke_button__uploadimg")){
			$(obj).click();
		}
		
		function assemblyParam(parameters){
			var newParams="?";
			$.each(parameters,function(n,value) {    
				newParams+=n+'='+value+"&"; 
			}); 
			return newParams;
		}
	
		function tb_init_click(){
			var src="";
			var t = this.title || this.name || options.title;
			var url = this.href || this.alt;
			if(undefined==urlTypes[options.type]){
				src = url;
			}else{
				src =options.ctxpath+urlTypes[options.type];
				src = src.replace(/\?/,assemblyParam(options.parameters));
			}	
			ctxurl = src;
			var g = this.rel || false;
			//图片下载
			var params = {};
			params.d3d=$(this).attr("d3d");
			params.nodeId=$(this).attr("nodeId");
			
			tb_show(t,ctxurl,g,params);
			this.blur();
			return false;
		}
		
		function tb_show(caption, url, imageGroup,params) {//function called when the user clicks on a thickbox link

			try {
				if (typeof document.body.style.maxHeight === "undefined") {//if IE 6
					$("body","html").css({height: "100%", width: "100%"});
					$("html").css("overflow","hidden");
					if (document.getElementById("TB_HideSelect") === null) {//iframe to hide select elements in ie6
						$("body").append("<div id='TB_overlay'><iframe id='TB_HideSelect'></iframe></div><div id='TB_window'></div>");
						//$("#TB_overlay").click(tb_remove);
					}
				}else{//all others
					if(document.getElementById("TB_overlay") === null){
						$("body").append("<div id='TB_overlay'><iframe id='TB_HideSelect'></iframe></div><div id='TB_window'></div>");
						//$("#TB_overlay").click(tb_remove);
					}
				}
				$("#TB_window").attr("rank_menu",options.rank_menu);
				if(tb_detectMacXFF()){
					$("#TB_overlay").addClass("TB_overlayMacFFBGHack");//use png overlay so hide flash
				}else{
					$("#TB_overlay").addClass("TB_overlayBG");//use background and opacity
				}
				
				if(caption===null){caption="";}
				$("body").append("<div id='TB_load'><img src='"+options.resmod+options.loadimg+"' /></div>");//add loader to the page
				$('#TB_load').show();//show loader
				
			   var baseURL;
			   if(url.indexOf("?")!==-1){ //ff there is a query string involved
					baseURL = url.substr(0, url.indexOf("?"));
			   }else{ 
			   		baseURL = url;
			   }
			  
			   var urlString = /\.jpg$|\.jpeg$|\.png$|\.gif$|\.bmp$/;
			   var urlType = baseURL.toLowerCase().match(urlString);

				if(urlType == '.jpg' || urlType == '.jpeg' || urlType == '.png' || urlType == '.gif' || urlType == '.bmp'){//code to show images
						
					TB_PrevCaption = "";
					TB_PrevURL = "";
					TB_PrevHTML = "";
					TB_NextCaption = "";
					TB_NextURL = "";
					TB_NextHTML = "";
					TB_imageCount = "";
					TB_FoundURL = false;
					if(imageGroup){
						TB_TempArray = $("a[rel="+imageGroup+"]").get();
						if(TB_TempArray.length>1){
						  for (var TB_Counter = 0; ((TB_Counter < TB_TempArray.length) && (TB_NextHTML === "")); TB_Counter++) {
								if (!(TB_TempArray[TB_Counter].href == url)) {	
									if (TB_FoundURL) {
										TB_NextCaption = TB_TempArray[TB_Counter].title;
										TB_NextURL = TB_TempArray[TB_Counter].href;
										TB_NextHTML ="<span class='TB_next'><a href='javascript:;' class='Blue b u'>&gt;</a></span>";
									} else {
										TB_PrevCaption = TB_TempArray[TB_Counter].title;
										TB_PrevURL = TB_TempArray[TB_Counter].href;
										TB_PrevHTML = "<span class='TB_prev'><a href='javascript:;' class='Blue b u'>&lt;</a></span>";
									}
								} else {
									TB_FoundURL = true;
									TB_imageCount = "&nbsp;&nbsp;"+(TB_Counter + 1) +"/"+ (TB_TempArray.length)+"&nbsp;&nbsp;";
									params.d3d = $(TB_TempArray[TB_Counter]).attr("d3d");
									params.nodeId=$(TB_TempArray[TB_Counter]).attr("nodeId");
								}
						  }
						}
					}

					imgPreloader = new Image();
					imgPreloader.onload = function(){		
					imgPreloader.onload = null;
						
					// Resizing large images - orginal by Christian Montoya edited by me.
					var pagesize = tb_getPageSize();
					var x = pagesize[0] - 150;
					var y = pagesize[1] - 150;
					var imageWidth = imgPreloader.width;
					var imageHeight = imgPreloader.height;
					imageWidth = imageWidth<250?250:imageWidth;
					if (imageWidth > x) {
						imageHeight = imageHeight * (x / imageWidth); 
						imageWidth = x; 
						if (imageHeight > y) { 
							imageWidth = imageWidth * (y / imageHeight); 
							imageHeight = y; 
						}
					} else if (imageHeight > y) { 
						imageWidth = imageWidth * (y / imageHeight); 
						imageHeight = y; 
						if (imageWidth > x) { 
							imageHeight = imageHeight * (x / imageWidth); 
							imageWidth = x;
						}
					}
					var resimg="查看原图";
					var prev_text="上一张";
					var next_text="下一张";
					if(locale && locale=='en_US'){
						resimg="Original size";
						prev_text="Previous";
						next_text="Next";
					}
					// End Resizing
					TB_WIDTH = imageWidth+20;
					TB_HEIGHT = imageHeight+70;
					var img_focus_next_top = (imageHeight-72)/2;
					
					$("#TB_window").css("padding-left","0px").css("padding-top","0px").css("padding-right","0px");
					if(TB_TempArray.length>1){
						$("#TB_window").append("<div class='tb_img_div' style='position:relative'><a href='' id='TB_ImageOff' title='Close'><img id='TB_Image' src='"+url+"' width='"+imageWidth+"' height='"+imageHeight+"' alt='"+caption+"'/></a><div class='img_focus_pre TB_prev'><a href='javascript:;' style='top:"+img_focus_next_top+"px;' title='"+prev_text+"'></a></div><div class='img_focus_next TB_next'><a href='javascript:;' style='top:"+img_focus_next_top+"px;' title='"+next_text+"'></a></div></div>");
					}else{
						$("#TB_window").append("<div class='tb_img_div' style='position:relative'><a href='' id='TB_ImageOff' title='Close'><img id='TB_Image' src='"+url+"' width='"+imageWidth+"' height='"+imageHeight+"' alt='"+caption+"'/></a></div>");
					}
					
					TB_PrevHTML = TB_PrevHTML.length==0?"<span class='b'>&lt;</span>":TB_PrevHTML;
					TB_NextHTML = TB_NextHTML.length==0?"<span class='b'>&gt;</span>":TB_NextHTML;
					
					if (options.isShowImgLink) {
						//if(TB_TempArray.length>1){
						//  $("#TB_window").append("<div style='width:"+(parseInt(imageWidth)-20)+"px;margin-left:10px;padding-top:5px;padding-bottom:5px;padding-left: 10px;padding-right:10px;background-color: #f0eff1;'><table width='100%' style='padding:5px;color:#333;'><tr><td width='45%'><a href='"+url+"' class='Blue' target='_blank'>"+resimg+"</a></td><td align='center'>"+TB_PrevHTML+TB_imageCount+TB_NextHTML+"</td><td width='45%' align='right'><a href='javascript:void(0)' class='Blue b' id='TB_closeWindowButton' title='Close'><img src='"+options.resmod+"/images_v5/mbClose.gif'/></a></td></tr></table></div>");
						//}else{
							$("#TB_window").append("<div style='width:"+(parseInt(imageWidth)-20)+"px;margin-left:10px;padding-top:5px;padding-bottom:5px;padding-left: 10px;padding-right:10px;background-color: #f0eff1;'><table width='100%' style='padding:5px;color:#333;'><tr><td width='45%'><a href='"+url+"' class='Blue' target='_blank'>"+resimg+"</a></td><td width='20%' align='right'><a href='javascript:void(0)' class='Blue b' id='TB_closeWindowButton' title='"+options.closeStr+"'><img src='"+options.resmod+"/images/mbClose.gif'/></a></td></tr></table></div>");
						//}
					} else {
						$("#TB_window").append("<div style='width:"+(parseInt(imageWidth)-20)+"px;margin-left:10px;padding-top:5px;padding-bottom:5px;padding-left: 10px;padding-right:10px;background-color: #f0eff1;'><table width='100%' style='padding:5px;color:#333;'><tr><td width='45%'></td><td align='center'></td><td width='45%' align='right'><a href='javascript:void(0)' class='Blue b' id='TB_closeWindowButton' title='"+options.closeStr+"'><img src='"+options.resmod+"/images/mbClose.gif'/></a></td></tr></table></div>");
					}
					//增加关闭事件允许处理额外的逻辑
					$("#TB_closeWindowButton").click(options["closeEvent"]==null?tb_remove:function(){options["closeEvent"](tb_remove);});
					
					if (!(TB_PrevHTML === "")) {
						function goPrev(){
							if(TB_PrevURL==""){
								TB_PrevURL=TB_TempArray[TB_TempArray.length-1].href;
							}
							if($(document).unbind("click",goPrev)){$(document).unbind("click",goPrev);}
							$("#TB_window").remove();
							$("body").append("<div id='TB_window'></div>");
							tb_show(TB_PrevCaption, TB_PrevURL, imageGroup,params);
							return false;	
						}
						$(".TB_prev").click(goPrev);
					}
					
					if (!(TB_NextHTML === "")) {		
						function goNext(){
							if(TB_NextURL==""){
								TB_NextURL = TB_TempArray[0].href;
							}
							$("#TB_window").remove();
							$("body").append("<div id='TB_window'></div>");
							tb_show(TB_NextCaption, TB_NextURL, imageGroup,params);				
							return false;	
						}
						$(".TB_next").click(goNext);
						
					}

					document.onkeydown = function(e){ 	
						if (e == null) { // ie
							keycode = event.keyCode;
						} else { // mozilla
							keycode = e.which;
						}
						if(keycode == 27){ // close
							tb_remove();
						} else if(keycode == 190){ // display previous image
							if(!(TB_NextHTML == "")){
								document.onkeydown = "";
								goNext();
							}
						} else if(keycode == 188){ // display next image
							if(!(TB_PrevHTML == "")){
								document.onkeydown = "";
								goPrev();
							}
						}	
					};
					
					tb_position();
					$("#TB_load").remove();
					$("#TB_ImageOff").click(tb_remove);
					$("#TB_window").css({display:"block"}); //for safari using css instead of show
					};
					
					imgPreloader.src = url;
				}else{//code to show html
					
					var queryString = url.replace(/^[^\?]+\??/,'');
					var params = tb_parseQuery( queryString );

					TB_WIDTH = (params['width']*1) + 2 || 630; //defaults to 630 if no paramaters were added to URL
					TB_HEIGHT = (params['height']*1) + 30 || 440; //defaults to 440 if no paramaters were added to URL
					ajaxContentW = TB_WIDTH - 2;
					ajaxContentH = TB_HEIGHT - 30;
					if(url.indexOf('TB_iframe') != -1){// either iframe or ajax window
						urlNoQuery = url.split('TB_');
						$("#TB_iframeContent").remove();
						if(params['modal'] != "true"){//iframe no modal 
							$("#TB_window").append("<div id='TB_title' style="+ajaxContentW+"><div id='TB_ajaxWindowTitle'>"+caption+"</div><div id='TB_closeAjaxWindow'><a href='javascript:;' id='TB_closeWindowButton' title='"+options.closeStr+"'><img src='/ressns/images/mbClose2.gif' alt='' border='0' /></a></div></div><iframe frameborder='0' hspace='0' src='"+urlNoQuery[0]+"' id='TB_iframeContent' scrolling='auto' name='TB_iframeContent"+Math.round(Math.random()*1000)+"' style='width:"+ajaxContentW+"px;height:"+ajaxContentH +"px; overflow-x:hidden; border:solid #395c93; border-width:0px 1px 1px 1px;' > </iframe>");
							$("#TB_iframeContent").onload = tb_showIframe();
						}else{//iframe modal
							$("#TB_overlay").unbind();
							$("#TB_window").append("<a href='javascript:;' id='TB_closeWindowButton' style='display:none;'></a><iframe frameborder='0' hspace='0' src='"+urlNoQuery[0]+"' id='TB_iframeContent' name='TB_iframeContent"+Math.round(Math.random()*1000)+"' style='width:"+ajaxContentW+"px;height:"+ajaxContentH+"px;' > </iframe>");
							$("#TB_iframeContent").onload = tb_showIframe();
						}
						tb_position();
					}else{// not an iframe, ajax
							if($("#TB_window").css("display") != "block"){ 
								if( params['modal'] != "true"){//ajax no modal
										$("#TB_window").append("<div id='TB_title' style="+ajaxContentW+"><div id='TB_ajaxWindowTitle'>"+caption+"</div><div id='TB_closeAjaxWindow'><a href='javascript:;' id='TB_closeWindowButton'><img src='/ressns/images/mbClose2.gif' alt='' border='0' /></a></div></div><div id='TB_ajaxContent' style='width:"+ajaxContentW+"px;height:"+ajaxContentH+"px'></div>");
								}else{//ajax modal
									$("#TB_overlay").unbind();
									$("#TB_window").append("<a href='javascript:;' id='TB_closeWindowButton' style='display:none;'></a><div id='TB_ajaxContent' class='TB_modal' style='width:"+ajaxContentW+"px;height:"+ajaxContentH+"px;'></div>");	
								}
							}else{//this means the window is already up, we are just loading new content via ajax 
								//$("#TB_ajaxContent")[0].style.width = ajaxContentW +"px";
								$("#TB_ajaxContent")[0].style.height = ajaxContentH +"px";
								$("#TB_ajaxContent")[0].scrollTop = 0;
								$("#TB_ajaxWindowTitle").html(caption);
							}
					}
					//增加关闭事件允许处理额外的逻辑
					$("#TB_closeWindowButton").click(options["closeEvent"]==null?tb_remove:function(){options["closeEvent"](tb_remove);});
					
					if(url.indexOf('TB_inline') != -1){
						$("#TB_ajaxContent").append($('#' + params['inlineId']).children());
						$("#TB_window").unload(function () {
							$('#' + params['inlineId']).append( $("#TB_ajaxContent").children() ); // move elements back when you're finished
						});
						tb_position();
						$("#TB_load").remove();
						$("#TB_window").css({display:"block"}); 
					}else if(url.indexOf('TB_iframe') != -1){
						if($.browser.safari){//safari needs help because it will not fire iframe onload
							$("#TB_load").remove();
							$("#TB_window").css({display:"block"});
						}
					}else{
						$("#TB_ajaxContent").load(url += "&random=" + (new Date().getTime()),function(){//to do a post change this load method
							tb_position();
							$("#TB_load").remove();
							tb_init_click("#TB_ajaxContent a.thickbox"); 
							$("#TB_window").css({display:"block"});
						});
					}
				}
				
			} catch(e) {
				//nothing here
				$("#TB_load").remove();
			}
		}

		//helper functions below
		function tb_showIframe(){
			$("#TB_load").remove();
			$("#TB_window").css({display:"block"});
		}

		function tb_remove() { 
		 	$("#TB_imageOff").unbind("click");
			$("#TB_closeWindowButton").unbind("click");
			$("#TB_window").fadeOut("fast",function(){
				if(navigator.userAgent.indexOf("MSIE")>0) { 
					$('#TB_iframeContent').remove(); 
				}
				$('#TB_window,#TB_overlay,#TB_HideSelect').trigger("unload").unbind().remove();
				if(navigator.userAgent.indexOf("MSIE")>0) { 
					CollectGarbage(); 
				}
			});
			$("#TB_load").remove();
			if (typeof document.body.style.maxHeight == "undefined") {//if IE 6
				$("body","html").css({height: "auto", width: "auto"});
				$("html").css("overflow","");
			}
			if(typeof callBack!="undefined"){
				 callBack();//回调函数
			}
			if(typeof thickbox_close_callBack!="undefined"){
				thickbox_close_callBack($("#TB_ajaxContent"));//关闭弹出框回调函数
			}
			document.onkeydown = "";
			document.onkeyup = ""; 
			return false;
		}

		function tb_position() {

			$("#TB_window").css({marginLeft: '-' + parseInt((TB_WIDTH / 2),10) + 'px', width: TB_WIDTH + 'px'});
//			var isIE6 =$.browser.msie && parseInt($.browser.version) === 6 && !$.support.style;
//			if ( !isIE6) { // take away IE6
				if(options.rank_menu){
					$("#TB_window").css({top: options.rank_menu_position+'px'});
				}else{
					$("#TB_window").css({marginTop: '-' + parseInt((TB_HEIGHT / 2),10) + 'px'});
				}
//			}
		}

		function tb_parseQuery ( query ) {
		   var Params = {};
		   if ( ! query ) {return Params;}// return empty object
		   var Pairs = query.split(/[;&]/);
		   for ( var i = 0; i < Pairs.length; i++ ) {
		      var KeyVal = Pairs[i].split('=');
		      if ( ! KeyVal || KeyVal.length != 2 ) {continue;}
		      var key = unescape( KeyVal[0] );
		      var val = unescape( KeyVal[1] );
		      val = val.replace(/\+/g, ' ');
		      Params[key] = val;
		   }
		   return Params;
		}

		function tb_getPageSize(){
			var de = document.documentElement;
			var w = window.innerWidth || self.innerWidth || (de&&de.clientWidth) || document.body.clientWidth;
			var h = window.innerHeight || self.innerHeight || (de&&de.clientHeight) || document.body.clientHeight;
			arrayPageSize = [w,h];
			return arrayPageSize;
		}

		function tb_detectMacXFF(){
		  var userAgent = navigator.userAgent.toLowerCase();
		  if (userAgent.indexOf('mac') != -1 && userAgent.indexOf('firefox')!=-1) {
		    return true;
		  }
		}
	};
	$.Thickbox.closeWin = function(){
		$("#TB_closeWindowButton").trigger("click");
	};
	$.Thickbox.clearMenuRank = function(){
		$("#TB_window").removeAttr("rank_menu");
	};
	
	$.Thickbox.modifyHeight=function(flag,marginHeight,initHeight){//flag：1：增高，2-降高；height-高度变化幅度;initHeight初始高度用于重设
		var TB_windowObj=$("#TB_window");
		var TB_windowHeight=$(TB_windowObj).height();
		var TB_iframeObj=$("#TB_iframeContent");
		var TB_ajaxObj=$("#TB_ajaxContent");
		var rank_menu = TB_windowObj.attr("rank_menu");
		if(rank_menu == "true"){
			rank_menu = true;
		}else{
			rank_menu = false;
		}
		if(flag==1){
			$(TB_windowObj).css("height",TB_windowHeight+marginHeight);
			var restop = 0;
			
			if(!rank_menu){
				restop = (parseInt($(TB_windowObj).css("margin-top").replace("px"))-parseInt(marginHeight/2))+"px";
			}
			$(TB_windowObj).css("margin-top",restop);
			if(TB_iframeObj.length>0){
				var TB_iframeHeight=$(TB_iframeObj).height();
				$(TB_iframeObj).css("height",TB_iframeHeight+marginHeight);
			}
			if(TB_ajaxObj.length>0){
				var TB_ajaxHeight=$(TB_ajaxObj).height();
				$(TB_ajaxObj).css("height",TB_ajaxHeight+marginHeight);
			}
		}else if(flag==2){
			$(TB_windowObj).css("height",TB_windowHeight-marginHeight);
			var restop = 0;
			if(!rank_menu){
				restop = (parseInt($(TB_windowObj).css("margin-top").replace("px"))+parseInt(marginHeight/2))+"px";
			}
			$(TB_windowObj).css("margin-top",restop);
			if(TB_iframeObj.length>0){
				var TB_iframeHeight=$(TB_iframeObj).height();
				$(TB_iframeObj).css("height",TB_iframeHeight-marginHeight);
			}
			if(TB_ajaxObj.length>0){
				var TB_ajaxHeight=$(TB_ajaxObj).height();
				$(TB_ajaxObj).css("height",TB_ajaxHeight-marginHeight);
			}
		}else if(flag==0){
			$(TB_windowObj).css("height",TB_windowHeight-initHeight+marginHeight);
			if(TB_iframeObj.length>0){
				var TB_iframeHeight=$(TB_iframeObj).height();
				$(TB_iframeObj).css("height",TB_iframeHeight-initHeight+marginHeight);
			}
			if(TB_ajaxObj.length>0){
				var TB_ajaxHeight=$(TB_ajaxObj).height();
				$(TB_ajaxObj).css("height",TB_ajaxHeight-initHeight+marginHeight);
			}
		}
	};
	$.Thickbox.resetHeight=function(new_height){
		var TB_HEIGHT = new_height + 30 || $("#TB_window").height();
		ajaxContentH = TB_HEIGHT - 26;
		var restop = -(parseInt(new_height/2))+"px";	
		$("#TB_window").css("margin-top",restop);
		$("#TB_iframeContent").height(ajaxContentH);
		$("#TB_ajaxContent").height(ajaxContentH);
	};
	$.Thickbox.modifyWidth=function(marginWidth,initWidth){
		var TB_windowObj=$("#TB_window");
		var TB_windowWidth=$(TB_windowObj).width();
		var TB_iframeObj=$("#TB_iframeContent");
		var TB_ajaxObj=$("#TB_ajaxContent");
		var resleft = (parseInt($(TB_windowObj).css("margin-left").replace("px"))-parseInt(marginWidth/2))+"px";
		$(TB_windowObj).css("margin-left",resleft);
		
		$(TB_windowObj).css("width",TB_windowWidth-initWidth+marginWidth);
		if(TB_iframeObj.length>0){
			var TB_iframeWidth=$(TB_iframeObj).width();
			$(TB_iframeObj).css("width",TB_iframeWidth-initWidth+marginWidth);
		}
		if(TB_ajaxObj.length>0){
			var TB_ajaxWidth=$(TB_ajaxObj).width();
			$(TB_ajaxObj).css("width",TB_ajaxWidth-initWidth+marginWidth);
		}	
	};
	$.Thickbox.resetWidth=function(new_width){
		var TB_WIDTH = new_width + 2 || $("#TB_window").width();
		ajaxContentW = TB_WIDTH - 2;
		var resleft = -(parseInt(new_width/2))+"px";
		$("#TB_window").css("width",TB_WIDTH);
		$("#TB_title").css("width",ajaxContentW);
		$("#TB_window").css("margin-left",resleft);
		$("#TB_iframeContent").width(ajaxContentW);
		$("#TB_ajaxContent").width(ajaxContentW);
	};
})(jQuery);
